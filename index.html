<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>DOCX → Sections</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        margin: 24px;
      }
      .drop {
        border: 2px dashed #999;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
      }
      .drop.drag {
        border-color: #333;
        background: #f6f6f6;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .btn {
        padding: 10px 14px;
        border: 1px solid #333;
        border-radius: 10px;
        background: white;
        cursor: pointer;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .status {
        margin: 12px 0;
        color: #333;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        margin-top: 18px;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 14px;
      }
      .card h2 {
        margin: 0 0 10px;
        font-size: 16px;
      }
      .html-output {
        width: 100%;
        min-height: 240px;
        max-height: 500px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid #ccc;
        padding: 14px;
        background: white;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        font-size: 14px;
        line-height: 1.6;
      }
      .html-output :first-child {
        margin-top: 0;
      }
      .html-output :last-child {
        margin-bottom: 0;
      }
      .html-output h1,
      .html-output h2,
      .html-output h3,
      .html-output h4,
      .html-output h5,
      .html-output h6 {
        margin: 1em 0 0.5em;
        font-weight: 600;
      }
      .html-output ul,
      .html-output ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
      }
      .html-output li {
        margin: 0.25em 0;
      }
      .html-output p {
        margin: 0.5em 0;
      }
      .html-output blockquote {
        margin: 0.5em 0;
        padding-left: 1em;
        border-left: 3px solid #ddd;
      }
      .html-output code,
      .html-output pre {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.9em;
      }
      .html-output pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .html-output a {
        color: #0066cc;
        text-decoration: underline;
      }
      .html-output.viewing-source {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace !important;
        font-size: 12px !important;
        white-space: pre-wrap !important;
        background: #f9f9f9 !important;
      }
      .card .actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .view-toggle {
        font-size: 12px;
        padding: 6px 10px;
      }
      .small {
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>DOCX → Sections</h1>

    <div id="drop" class="drop">
      <div><strong>Drag & drop</strong> a <code>.docx</code> here</div>
      <div class="small">or</div>
      <div class="row">
        <input id="file" type="file" accept=".docx" />
      </div>
    </div>

    <div id="status" class="status"></div>

    <div id="out" class="grid" style="display: none">
      <div class="card">
        <h2>Jurisdiction</h2>
        <div id="sec-jur" class="html-output"></div>
        <div class="actions">
          <button class="btn view-toggle" data-toggle="sec-jur">
            View HTML
          </button>
          <button class="btn" data-copy="sec-jur">Copy HTML</button>
        </div>
      </div>

      <div class="card">
        <h2>Thresholds</h2>
        <div id="sec-thr" class="html-output"></div>
        <div class="actions">
          <button class="btn view-toggle" data-toggle="sec-thr">
            View HTML
          </button>
          <button class="btn" data-copy="sec-thr">Copy HTML</button>
        </div>
      </div>

      <div class="card">
        <h2>Procedures</h2>
        <div id="sec-proc" class="html-output"></div>
        <div class="actions">
          <button class="btn view-toggle" data-toggle="sec-proc">
            View HTML
          </button>
          <button class="btn" data-copy="sec-proc">Copy HTML</button>
        </div>
      </div>

      <div class="card">
        <h2>Standard of Review / Penalties</h2>
        <div id="sec-std" class="html-output"></div>
        <div class="actions">
          <button class="btn view-toggle" data-toggle="sec-std">
            View HTML
          </button>
          <button class="btn" data-copy="sec-std">Copy HTML</button>
        </div>
      </div>
    </div>

    <script>
      const drop = document.getElementById("drop");
      const fileInput = document.getElementById("file");
      const statusEl = document.getElementById("status");
      const out = document.getElementById("out");

      const secJur = document.getElementById("sec-jur");
      const secThr = document.getElementById("sec-thr");
      const secProc = document.getElementById("sec-proc");
      const secStd = document.getElementById("sec-std");

      // Store HTML source for each section
      const htmlSources = {
        "sec-jur": "",
        "sec-thr": "",
        "sec-proc": "",
        "sec-std": "",
      };

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      async function handleFile(f) {
        if (!f) return;
        setStatus(`Processing: ${f.name}`);
        try {
          const htmlText = await convertDocx(f);
          const sections = splitSections(htmlText);

          // Store HTML sources and render
          htmlSources["sec-jur"] = sections.jurisdiction;
          htmlSources["sec-thr"] = sections.thresholds;
          htmlSources["sec-proc"] = sections.procedures;
          htmlSources["sec-std"] = sections.standard;

          secJur.innerHTML = sections.jurisdiction;
          secThr.innerHTML = sections.thresholds;
          secProc.innerHTML = sections.procedures;
          secStd.innerHTML = sections.standard;

          out.style.display = "grid";
          setStatus("Done.");
        } catch (err) {
          setStatus("Error: " + (err?.message || err));
        }
      }

      fileInput.addEventListener("change", () => {
        const f = fileInput.files?.[0];
        if (f) handleFile(f);
      });

      // Drag & drop
      ["dragenter", "dragover"].forEach((evt) =>
        drop.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          drop.classList.add("drag");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        drop.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          drop.classList.remove("drag");
        })
      );

      drop.addEventListener("drop", (e) => {
        const f = e.dataTransfer.files?.[0];
        if (f) {
          fileInput.value = "";
          handleFile(f);
        }
      });

      function splitSections(htmlText) {
        // Markers (case-insensitive)
        const textLower = htmlText.toLowerCase();
        const mThr = "foreign investors:";
        const mProc = "authority in charge";
        const mStd = "standard of review";

        const iThr = textLower.indexOf(mThr);
        const iProc = textLower.indexOf(mProc);
        const iStd = textLower.indexOf(mStd);

        // If markers missing, fall back gracefully
        const safeSlice = (a, b) =>
          htmlText
            .slice(Math.max(0, a), b == null || b < 0 ? htmlText.length : b)
            .trim();

        const jurisdiction = iThr >= 0 ? safeSlice(0, iThr) : htmlText.trim();
        const thresholds =
          iThr >= 0 && iProc >= 0
            ? safeSlice(iThr, iProc)
            : iThr >= 0
            ? safeSlice(iThr, iProc)
            : "";
        const procedures =
          iProc >= 0 && iStd >= 0
            ? safeSlice(iProc, iStd)
            : iProc >= 0
            ? safeSlice(iProc, iStd)
            : "";
        const standard = iStd >= 0 ? safeSlice(iStd, null) : "";

        return { jurisdiction, thresholds, procedures, standard };
      }

      async function convertDocx(file) {
        setStatus("Converting…");
        out.style.display = "none";
        secJur.innerHTML =
          secThr.innerHTML =
          secProc.innerHTML =
          secStd.innerHTML =
            "";
        htmlSources["sec-jur"] =
          htmlSources["sec-thr"] =
          htmlSources["sec-proc"] =
          htmlSources["sec-std"] =
            "";

        const fd = new FormData();
        fd.append("file", file);

        const res = await fetch("/api", { method: "POST", body: fd });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || `HTTP ${res.status}`);
        }
        return await res.text();
      }

      // Toggle between rendered HTML and HTML source
      document.addEventListener("click", async (e) => {
        const toggleBtn = e.target.closest("[data-toggle]");
        if (toggleBtn) {
          const id = toggleBtn.getAttribute("data-toggle");
          const el = document.getElementById(id);
          const isViewingSource = el.classList.contains("viewing-source");

          if (isViewingSource) {
            // Switch back to rendered HTML
            el.innerHTML = htmlSources[id];
            el.classList.remove("viewing-source");
            toggleBtn.textContent = "View HTML";
          } else {
            // Switch to HTML source
            const source = htmlSources[id] || "";
            el.textContent = source;
            el.classList.add("viewing-source");
            toggleBtn.textContent = "View Rendered";
          }
          return;
        }

        // Copy buttons
        const btn = e.target.closest("[data-copy]");
        if (!btn) return;
        const id = btn.getAttribute("data-copy");
        const htmlSource = htmlSources[id] || "";

        try {
          await navigator.clipboard.writeText(htmlSource);
          setStatus("Copied HTML to clipboard.");
        } catch {
          // Fallback
          const textarea = document.createElement("textarea");
          textarea.value = htmlSource;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
          setStatus("Copied HTML to clipboard.");
        }
      });
    </script>
  </body>
</html>
